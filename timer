#!/bin/sh

# Version number
VERSION="1.2.1"

# Default install location
INSTALL_PATH="/usr/local/bin/timer"

# Get current username
USERNAME=$(id -un 2>/dev/null || echo "unknown")

# Color support (basic)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' NC=''
fi

# Directories
VOLATILE_DIR="/dev/shm"
PERSISTENT_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/timer"

# Get timer file path
get_timer_file() {
    local name="$1"
    local mode="$2"  # "volatile" or "persistent"
    local base_dir
    if [ "$mode" = "persistent" ]; then
        base_dir="$PERSISTENT_DIR"
        mkdir -p "$base_dir" 2>/dev/null
    else
        base_dir="$VOLATILE_DIR"
    fi
    echo "${base_dir}/timer_${USERNAME}_${name}"
}

# List all running timers for current user
list_timers() {
    local mode="$1"
    local base_dir
    if [ "$mode" = "persistent" ]; then
        base_dir="$PERSISTENT_DIR"
    else
        base_dir="$VOLATILE_DIR"
    fi

    if [ ! -d "$base_dir" ]; then
        echo "No running timers found."
        return
    fi

    found=0
    for file in "${base_dir}"/timer_"${USERNAME}"_*; do
        [ -f "$file" ] || continue
        found=1
        name="${file##*timer_${USERNAME}_}"
        start_time=$(cat "$file") || continue
        current_time=$(date +%s) || continue
        elapsed=$((current_time - start_time))
        minutes=$((elapsed / 60))
        seconds=$((elapsed % 60))
        printf "${GREEN}%-12s${NC} running for %2d min %2d sec\n" "$name" "$minutes" "$seconds"
    done

    [ "$found" -eq 0 ] && echo "No running timers found."
}

# Check if we're installed globally
is_installed() {
    [ -f "$INSTALL_PATH" ] && [ -x "$INSTALL_PATH" ]
}

# Installation suggestion + interactive/auto logic
show_install_suggestion() {
    if is_installed; then
        return
    fi

    echo ""
    echo "${YELLOW}⚠️  Note: This script is not installed in $INSTALL_PATH${NC}"
    echo "     For better usability, you can install it globally:"
    echo ""
    echo "     curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sh"
    echo ""

    # Detect if we can interact with user
    if [ -t 0 ] && [ -t 1 ]; then
        # Interactive terminal available → ask
        printf "     Would you like to install it now? (y/N): "
        read -r answer </dev/tty 2>/dev/null || read -r answer
        case "$answer" in
            [Yy]*)
                echo "Installing (interactive confirmation)..."
                ;;
            *)
                echo "Continuing without installation..."
                return
                ;;
        esac
    else
        # No tty → automatic installation (piped curl | sh case)
        echo "Non-interactive mode detected → performing automatic installation..."
        echo ""
    fi

    # Perform the installation (common for both cases)
    TMP_SCRIPT="/tmp/timer_install_$$"
    if ! curl -fsSL "https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer" -o "$TMP_SCRIPT"; then
        echo "${RED}Failed to download latest version${NC}" >&2
        rm -f "$TMP_SCRIPT" 2>/dev/null
        return 1
    fi

    if ! chmod 755 "$TMP_SCRIPT"; then
        echo "${RED}Failed to make script executable${NC}" >&2
        rm -f "$TMP_SCRIPT"
        return 1
    fi

    if cp "$TMP_SCRIPT" "$INSTALL_PATH" 2>/dev/null; then
        echo "${GREEN}Installation successful!${NC}"
        echo "You can now use 'timer' from anywhere."
        rm -f "$TMP_SCRIPT"
        exit 0
    else
        echo "${RED}Failed to copy to $INSTALL_PATH${NC}" >&2
        echo "You may need to run with sudo:"
        echo "  sudo curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sudo sh"
        rm -f "$TMP_SCRIPT"
        return 1
    fi
}

# Show help
show_help() {
    cat << 'EOF'
timer - Simple per-user named timer (v1.2.1)

Usage:
  timer start [--persist] [name]      Start a timer
  timer stop [--force] [name]         Stop & show elapsed time
  timer kill [name]                   Alias for stop --force
  timer status [name]                 Show current elapsed time (no stop)
  timer list [--persist]              List all running timers
  timer version                       Show version
  timer help                          This help

Options:
  --persist        Use persistent storage (~/.cache/timer/) instead of RAM (/dev/shm)
  --force          Force discard without showing time

Examples:
  timer start work --persist
  timer list
  timer status coffee
  timer stop work
  timer kill oldtask --force
EOF
}

# ──────────────────────────────────────────────────────────────────────────────

PERSIST=false
FORCE=false
NAME="default"
COMMAND=""

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --persist) PERSIST=true; shift ;;
        --force)   FORCE=true; shift ;;
        start|stop|status|list|kill|version|help) COMMAND="$1"; shift ;;
        *) NAME="$1"; shift ;;
    esac
done

# Show suggestion (interactive or auto-install)
show_install_suggestion

# If no command was given after suggestion/install
[ -z "$COMMAND" ] && {
    echo "Usage: timer start|stop|status|list|kill|version|help [--persist] [--force] [name]" >&2
    exit 1
}

STORAGE_MODE=$([ "$PERSIST" = true ] && echo "persistent" || echo "volatile")
TIMER_FILE=$(get_timer_file "$NAME" "$STORAGE_MODE")

case "$COMMAND" in
    start)
        if [ -f "$TIMER_FILE" ]; then
            echo "${YELLOW}Timer '${NAME}' is already running.${NC}" >&2
            echo "  Use ${GREEN}timer status ${NAME}${NC} to check current time"
            echo "  Use ${GREEN}timer stop ${NAME}${NC} to finish normally"
            echo "  Use ${YELLOW}timer kill ${NAME} --force${NC} to discard it"
            exit 1
        fi
        date +%s > "$TIMER_FILE" || {
            echo "${RED}Error: Cannot create timer file.${NC}" >&2
            exit 1
        }
        echo "${GREEN}Timer '${NAME}' started at $(date '+%Y-%m-%d %H:%M:%S')${NC}"
        [ "$PERSIST" = true ] && echo "  (persistent mode)"
        ;;

    stop)
        if [ ! -f "$TIMER_FILE" ]; then
            echo "${YELLOW}No timer '${NAME}' is running.${NC}" >&2
            exit 1
        fi

        start_time=$(cat "$TIMER_FILE")
        rm -f "$TIMER_FILE"

        current_time=$(date +%s) || exit 1
        elapsed=$((current_time - start_time))
        minutes=$((elapsed / 60))
        seconds=$((elapsed % 60))

        if [ "$FORCE" = true ]; then
            echo "${YELLOW}Timer '${NAME}' discarded (forced).${NC}"
        else
            printf "${GREEN}Timer '%s' finished:${NC} %d min %d sec\n" "$NAME" "$minutes" "$seconds"
        fi
        ;;

    kill)
        FORCE=true
        # fall through to stop
        ;;

    status)
        if [ ! -f "$TIMER_FILE" ]; then
            echo "${YELLOW}No timer '${NAME}' is running.${NC}" >&2
            exit 1
        fi

        start_time=$(cat "$TIMER_FILE")
        current_time=$(date +%s) || exit 1
        elapsed=$((current_time - start_time))
        minutes=$((elapsed / 60))
        seconds=$((elapsed % 60))

        printf "${GREEN}Timer '%s' running for:${NC} %d min %d sec\n" "$NAME" "$minutes" "$seconds"
        [ "$PERSIST" = true ] && echo "  (persistent mode)"
        ;;

    list)
        echo "Running timers (${STORAGE_MODE}):"
        list_timers "$STORAGE_MODE"
        ;;

    version)
        echo "timer version $VERSION"
        ;;

    help)
        show_help
        ;;

    *)
        echo "${RED}Unknown command: $COMMAND${NC}" >&2
        echo "Use: timer help" >&2
        exit 1
        ;;
esac