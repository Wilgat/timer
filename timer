#!/bin/sh

# Version number
VERSION="1.0.1"

# Default install location
INSTALL_PATH="/usr/local/bin/timer"

# Get current username for per-user timer file
USERNAME=$(id -un 2>/dev/null || echo "unknown")
TEMPFILE="/dev/shm/timer_timestamp_$USERNAME"

# Check if we're already the installed version
is_installed() {
    [ -f "$INSTALL_PATH" ] && [ -x "$INSTALL_PATH" ]
}

# Check if we have permission to write to /usr/local/bin
can_install() {
    [ -w "/usr/local/bin" ] || [ -w "$(dirname "$INSTALL_PATH")" ]
}

install_self() {
    echo "Installing timer to $INSTALL_PATH..."

    TMP_SCRIPT="/tmp/timer.install.$$"

    # Download fresh copy from main branch
    if ! curl -fsSL "https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer" -o "$TMP_SCRIPT"; then
        echo "Error: Failed to download the script from GitHub." >&2
        return 1
    fi

    chmod +x "$TMP_SCRIPT" || {
        echo "Error: Failed to make temporary script executable." >&2
        rm -f "$TMP_SCRIPT"
        return 1
    }

    # Try to install (needs root/sudo)
    if cp "$TMP_SCRIPT" "$INSTALL_PATH" 2>/dev/null; then
        echo "Installation successful!"
        echo "You can now use 'timer' from anywhere."
        rm -f "$TMP_SCRIPT"
        return 0
    else
        echo "Error: Failed to copy to $INSTALL_PATH (permission denied?)" >&2
        echo ""
        echo "Try running the installation with sudo:"
        echo "  sudo curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sudo sh"
        echo ""
        rm -f "$TMP_SCRIPT"
        return 1
    fi
}

show_install_suggestion() {
    if is_installed; then
        return  # Already installed → no need to suggest
    fi

    echo ""
    echo "⚠️  Note: This script is not installed globally at $INSTALL_PATH"
    echo "     For better usability, install it system-wide:"
    echo ""
    echo "     curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sh"
    echo ""

    if can_install; then
        printf "     Would you like to install it now? (y/N): "
        read -r answer </dev/tty
        case "$answer" in
            [Yy]*)
                echo "Installing..."
                if install_self; then
                    echo "Please run your command again using just: timer $1"
                    exit 0
                else
                    echo "Installation failed. Continuing in local mode..."
                fi
                ;;
            *)
                echo "Continuing without installation..."
                ;;
        esac
    else
        echo "You don't have permission to write to /usr/local/bin."
        echo "Use sudo for global installation:"
        echo "  sudo curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sudo sh"
    fi
}

show_help() {
    cat << 'EOF'
timer - Simple per-user elapsed time tracker

Usage: timer <command>

Commands:
  start     Start a new timer for the current user
  stop      Stop timer and show elapsed time (minutes + seconds)
  version   Show current version
  help      Show this help message

Features:
  • Each user has their own independent timer
  • Uses fast in-memory storage (/dev/shm)
  • Timer auto-cleans on 'stop' or system reboot

Recommended global installation:
  curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sh

(If permission denied → use sudo)

Version: $VERSION
EOF
}

# ──────────────────────────────────────────────────────────────────────────────

if [ "$#" -ne 1 ]; then
    show_install_suggestion ""
    echo "Usage: timer start|stop|version|help" >&2
    exit 1
fi

case "$1" in
    start)
        show_install_suggestion "start"
        date +%s > "$TEMPFILE" 2>/dev/null || {
            echo "Error: Cannot write to $TEMPFILE" >&2
            exit 1
        }
        echo "Timer started for user '$USERNAME' at $(date '+%Y-%m-%d %H:%M:%S')"
        ;;

    stop)
        show_install_suggestion "stop"
        if [ ! -f "$TEMPFILE" ]; then
            echo "Error: No timer is running for user '$USERNAME'." >&2
            exit 1
        fi

        start_time=$(cat "$TEMPFILE")
        rm -f "$TEMPFILE"

        current_time=$(date +%s) || {
            echo "Error: Cannot get current time" >&2
            exit 1
        }

        elapsed=$((current_time - start_time))
        minutes=$((elapsed / 60))
        seconds=$((elapsed % 60))

        printf "Time elapsed for user '%s': %d minutes and %d seconds\n" "$USERNAME" "$minutes" "$seconds"
        ;;

    version)
        echo "timer version $VERSION"
        ;;

    help)
        show_help
        ;;

    *)
        show_install_suggestion "$1"
        echo "Invalid command: $1" >&2
        echo "Use: timer start|stop|version|help" >&2
        exit 1
        ;;
esac