#!/bin/sh

# Version number
VERSION="1.2.3"

# Default install location
INSTALL_PATH="/usr/local/bin/timer"

# Get current username
USERNAME=$(id -un 2>/dev/null || echo "unknown")

# Color support (basic)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' NC=''
fi

# Directories
VOLATILE_DIR="/dev/shm"
PERSISTENT_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/timer"

# ──────────────────────────────────────────────────────────────────────────────

# Check if we're already installed globally
is_installed() {
    [ -f "$INSTALL_PATH" ] && [ -x "$INSTALL_PATH" ]
}

# Show suggestion + interactive install prompt
show_install_suggestion() {
    if is_installed; then
        return
    fi

    echo ""
    echo "${YELLOW}⚠️  Note: This script is not installed in $INSTALL_PATH${NC}"
    echo "     For better usability, you can install it globally:"
    echo ""
    echo "     curl -fsSL https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer | sh"
    echo ""
    printf "     Would you like to install it now? (y/N): "

    # Try to read from tty if available, fallback to stdin
    if [ -t 0 ]; then
        read -r answer </dev/tty
    else
        read -r answer
    fi

    case "$answer" in
        [Yy]*)
            echo "Installing..."

            # Try to download fresh version and install
            TMP_SCRIPT="/tmp/timer_install_$$"
            if curl -fsSL "https://raw.githubusercontent.com/Wilgat/timer/refs/heads/main/timer" -o "$TMP_SCRIPT"; then
                chmod 755 "$TMP_SCRIPT" || {
                    echo "${RED}Failed to make script executable${NC}" >&2
                    rm -f "$TMP_SCRIPT"
                    return 1
                }

                if cp "$TMP_SCRIPT" "$INSTALL_PATH" 2>/dev/null; then
                    echo "${GREEN}Installation successful!${NC}"
                    echo "You can now use 'timer' from anywhere."
                    rm -f "$TMP_SCRIPT"
                    exit 0
                else
                    echo "${RED}Failed to copy to $INSTALL_PATH${NC}" >&2
                    echo "You may need to run with sudo."
                    rm -f "$TMP_SCRIPT"
                fi
            else
                echo "${RED}Failed to download latest version${NC}" >&2
            fi
            ;;
        *)
            echo "Continuing without installation..."
            ;;
    esac
}

# Show help (updated version)
show_help() {
    cat << 'EOF'
timer - Simple per-user named timer (v1.2.1)

Usage: timer <command> [--persist] [--force] [name]

Commands:
  start     Start a timer
  stop      Stop and show elapsed time
  kill      Discard timer (same as stop --force)
  status    Show current elapsed time (no stop)
  list      Show all running timers
  version   Show version
  help      This help

Options:
  --persist   Use persistent storage (~/.cache/timer/)
  --force     Force discard without showing time

Examples:
  timer start work --persist
  timer list
  timer status coffee
  timer stop work
  timer kill oldtask
EOF
}

# ──────────────────────────────────────────────────────────────────────────────

# The rest of your script (argument parsing + case statement) goes here...
# For brevity I'm not repeating the whole thing, but you can paste your existing
# main logic (PERSIST=false, FORCE=false, while loop, case "$COMMAND" in ...)
# right after this comment.

# Example minimal stub (replace with your full implementation):
PERSIST=false
FORCE=false
NAME="default"
COMMAND=""

while [ $# -gt 0 ]; do
    case "$1" in
        --persist) PERSIST=true; shift ;;
        --force)   FORCE=true; shift ;;
        start|stop|status|list|kill|version|help) COMMAND="$1"; shift ;;
        *) NAME="$1"; shift ;;
    esac
done

# Show suggestion if not installed
show_install_suggestion

# If no command → show usage after suggestion
[ -z "$COMMAND" ] && {
    echo "Usage: timer start|stop|status|list|kill|version|help [--persist] [--force] [name]" >&2
    exit 1
}

# ... your full case statement here ...